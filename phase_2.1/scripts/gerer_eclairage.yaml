# ==============================================================================
# SCRIPT CENTRAL DE GESTION D’ÉCLAIRAGE
# ==============================================================================
# Ce script est le cerveau qui orchestre l'éclairage de toute la maison.
# Il centralise les décisions pour éviter les conflits entre les commandes 
# vocales, les automatismes de présence et les cycles jour/nuit.
# ==============================================================================

alias: Gérer Éclairage
description: >-
  Intelligence centrale d'éclairage : 
  1. Calcule la scène idéale (Veilleuse/Atténué/Stimulation) selon l'heure.
  2. Gère les priorités (Le vocal est toujours prioritaire sur le capteur).
  3. Applique des sécurités (Ne rien faire si on n'est pas à la maison).
  4. Gère les exceptions (Ne pas allumer la chambre si quelqu'un dort).

# --- PARAMÈTRES REÇUS LORS DE L'APPEL ---
fields:
  piece:
    description: "La pièce où agir (doit correspondre au suffixe des entités : salon, cuisine, etc.)"
    example: "salon"
    required: true
  source:
    description: "Origine du signal : 'vocal_onoff' (Prioritaire), 'presence' ou 'absence'."
    example: "vocal_onoff"
    required: true
  action:
    description: "Pour le vocal uniquement : 'on', 'off' ou 'toggle'."
    example: "on"
    required: false

sequence:
  # ÉTAPE 0 : Condition de sécurité
  # On ne lance rien si personne n'est considéré comme étant à la maison.
  - condition: template
    value_template: "{{ states('sensor.etat_canabang_et_device_tracker') == 'home' }}"
  
  # ----------------------------------------------------------------------------
  # ÉTAPE 1 : PRÉPARATION ET CALCULS DYNAMIQUES
  # ----------------------------------------------------------------------------
  - variables:
      # Reconstruction dynamique de l'entité cible (ex: light.hue_salon)
      light_entity: "light.hue_{{ piece }}"
      is_light_on: "{{ is_state('light.hue_' + piece, 'on') }}"
      
      # Récupération de l'état global Jour/Nuit (via un input_text personnalisé)
      mode_nuit: "{{ is_state('input_text.jour_nuit', 'nuit') }}"
      
      # Vérification de l'élévation du soleil
      soleil_visible: "{{ state_attr('sun.sun', 'elevation') > 0 }}"
      
      # CALCUL DE LA SCÈNE IDÉALE (Le Cœur du script) :
      # On cherche à savoir s'il faut allumer en mode Veilleuse, Atténué ou Stimulation.
      scene_a_activer: >
        {# On vérifie depuis combien de temps le mode 'Jour' ou 'Nuit' a changé #}
        {% set dernier_changement_str = states('input_datetime.dernier_changement_jour_nuit') | default('1970-01-01 00:00:00') %}
        {% set maintenant_ts = as_timestamp(now()) %}
        {% if dernier_changement_str != 'unknown' and dernier_changement_str != 'unavailable' %}
          {% set dernier_changement_ts = as_timestamp(strptime(dernier_changement_str, '%Y-%m-%d %H:%M:%S')) %}
          {% set delta_minutes = ((maintenant_ts - dernier_changement_ts) / 60) | int %}
        {% else %}
          {% set delta_minutes = 99999 %}
        {% endif %}

        {# LOGIQUE DE SÉLECTION : #}
        {# 1. Si on est en mode nuit OU que le jour vient de se lever depuis < 15 min (Réveil) -> VEILLEUSE #}
        {% if mode_nuit or (not mode_nuit and delta_minutes < 15) %}
          scene.hue_{{ piece }}_1_veilleuse
        {# 2. Si le soleil est couché (Soirée) -> ATTÉNUÉ #}
        {% elif not soleil_visible %}
          scene.hue_{{ piece }}_3_attenue
        {# 3. Sinon (Plein jour) -> STIMULATION #}
        {% else %}
          scene.hue_{{ piece }}_2_stimulation
        {% endif %}

  # ÉTAPE 2 : Branchement par SOURCE
  - choose:
      # ------------------------------------------------------------------
      # CAS A : COMMANDE VOCALE (L'utilisateur a parlé)
      # ------------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: "{{ source == 'vocal_onoff' }}"
        sequence:
          - choose:
              # DATA : Allumer ou Éteindre selon l'action demandée
              - conditions:
                  - condition: or
                    conditions:
                      - condition: template
                        value_template: "{{ action == 'off' }}"
                      - condition: and
                        conditions:
                          - condition: template
                            value_template: "{{ action == 'toggle' and is_light_on }}"
                sequence:
                  - target:
                      entity_id: "{{ light_entity }}"
                    action: light.turn_off
              
              - conditions:
                  - condition: or
                    conditions:
                      - condition: template
                        value_template: "{{ action == 'on' }}"
                      - condition: and
                        conditions:
                          - condition: template
                            value_template: "{{ action == 'toggle' and not is_light_on }}"
                sequence:
                  - target:
                      entity_id: "{{ scene_a_activer }}"
                    action: scene.turn_on

      # ----------------------------------------------------------------------------
      # CAS B : DÉTECTION DE PRÉSENCE (Automatisme)
      # ----------------------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: "{{ source == 'presence' }}"
        sequence:
          # ÉTAPE : VÉRIFICATION DES BLOCAGES (Ne pas importuner l'utilisateur)
          - choose:
              # BLOCAGE 1 : CHAMBRE (Si le mode nuit est actif ou si quelqu'un est dans le lit)
              - conditions:
                  - condition: template
                    value_template: "{{ piece == 'chambre' }}"
                  - condition: or
                    conditions:
                      - condition: template
                        value_template: "{{ mode_nuit }}"
                      - condition: state
                        entity_id: binary_sensor.esp_bed_occupation_master_bed_occupied
                        state: "on"
                sequence:
                  - stop: "Blocage Sécurité : On ne réveille pas les dormeurs dans la chambre."
              
              # BLOCAGE 2 : SALLE DE BAIN (Si on est déjà dedans ou que la lumière est forte)
              - conditions:
                  - condition: template
                    value_template: "{{ piece == 'sdb' }}"
                  - condition: or
                    conditions:
                      - condition: state
                        entity_id: switch.prismal
                        state: "on"
                      - condition: numeric_state
                        entity_id: sensor.lux_sdb
                        above: 2
                sequence:
                  - stop: "Blocage Sécurité : SdB déjà occupée ou luminosité suffisante."
          
          # ACTIONS SI PAS DE BLOCAGE
          - choose:
              # On n'allume que si c'est éteint pour ne pas écraser une scène réglée manuellement
              - conditions:
                  - condition: template
                    value_template: "{{ not is_light_on }}"
                sequence:
                  - target:
                      entity_id: "{{ scene_a_activer }}"
                    action: scene.turn_on

      # ------------------------------------------------------------------
      # CAS C : ABSENCE DÉTECTÉE (Plus de mouvement)
      # ------------------------------------------------------------------
      - conditions:
          - condition: template
            value_template: "{{ source == 'absence' }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ is_light_on }}"
                sequence:
                  - target:
                      entity_id: "{{ light_entity }}"
                    action: light.turn_off

mode: parallel
