# ==========================================================
# LOGIQUE DES INTENTS - PHASE 2.1 (AVEC SCRIPT)
# ==========================================================
# Cette phase int√®gre le script 'gerer_eclairage' pour les lumi√®res
# afin de b√©n√©ficier de l'intelligence (sc√®nes dynamiques).
# ==========================================================

# ----------------------------------------------------------
# MODULE 1 : √âCLAIRAGE (VIA SCRIPT)
# ----------------------------------------------------------

# --- CONTEXTUEL (Pi√®ce actuelle) ---
# Ici, on n'appelle PAS light.turn_on directement. 
# On passe par le script qui va choisir la bonne sc√®ne selon l'heure.
TurnOnContextualLight:
  action:
    - variables:
        piece: "{{ states('sensor.satellite_actif_memorise') | lower }}"
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    
    - service: script.gerer_eclairage
      data:
        piece: "{{ piece }}"
        source: vocal_onoff
        action: "on"
        
    - service: persistent_notification.create
      data:
        title: "üí° Lumi√®re (Intelligence Script)"
        message: "Pi√®ce : **{{ piece }}** | Action : ON | Satellite : `{{ satellite_id }}`"

TurnOffContextualLight:
  action:
    - variables:
        piece: "{{ states('sensor.satellite_actif_memorise') | lower }}"
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    
    - service: script.gerer_eclairage
      data:
        piece: "{{ piece }}"
        source: vocal_onoff
        action: "off"
        
    - service: persistent_notification.create
      data:
        title: "üåë Lumi√®re (Intelligence Script)"
        message: "Pi√®ce : **{{ piece }}** | Action : OFF | Satellite : `{{ satellite_id }}`"

# --- GLOBAL (Toute la maison) ---
# Comme demand√©, le global reste en appel DIRECT sans passer par le script.
TurnOnAllLights:
  action:
    - variables:
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    - service: light.turn_on
      target:
        entity_id: light.hue_all
    - service: persistent_notification.create
      data:
        title: "üè† TOUTE LA MAISON (Direct)"
        message: "Action globale re√ßue via satellite : `{{ satellite_id }}`"

TurnOffAllLights:
  action:
    - variables:
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    - service: light.turn_off
      target:
        entity_id: light.hue_all
    - service: persistent_notification.create
      data:
        title: "üè† TOUTE LA MAISON (Direct)"
        message: "Action globale re√ßue via satellite : `{{ satellite_id }}`"


# ----------------------------------------------------------
# MODULE 2 : VOLETS (DIRECT)
# ----------------------------------------------------------

TurnOnContextualCover:
  action:
    - variables:
        piece: "{{ states('sensor.satellite_actif_memorise') | lower }}"
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    - service: cover.open_cover
      target:
        entity_id: "cover.vol{{ piece }}"
    - service: persistent_notification.create
      data:
        title: "ü™ü Volet Ouvert"
        message: "Pi√®ce : **{{ piece }}** | Satellite : `{{ satellite_id }}`"

TurnOffContextualCover:
  action:
    - variables:
        piece: "{{ states('sensor.satellite_actif_memorise') | lower }}"
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    - service: cover.close_cover
      target:
        entity_id: "cover.vol{{ piece }}"
    - service: persistent_notification.create
      data:
        title: "ü™ü Volet Ferm√©"
        message: "Pi√®ce : **{{ piece }}** | Satellite : `{{ satellite_id }}`"

TurnOnAllCovers:
  action:
    - variables:
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    - service: cover.open_cover
      target:
        entity_id: cover.volets
    - service: persistent_notification.create
      data:
        title: "üè† TOUS LES VOLETS Ouverts"
        message: "Action globale re√ßue via satellite : `{{ satellite_id }}`"

TurnOffAllCovers:
  action:
    - variables:
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    - service: cover.close_cover
      target:
        entity_id: cover.volets
    - service: persistent_notification.create
      data:
        title: "üè† TOUS LES VOLETS Ferm√©s"
        message: "Action globale re√ßue via satellite : `{{ satellite_id }}`"


# ----------------------------------------------------------
# MODULE 3 : RACCOURCIS (DIRECT)
# ----------------------------------------------------------

StartCoffeeLoop:
  action:
    - variables:
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    - service: switch.turn_on
      target:
        entity_id: switch.priscafe
    - service: persistent_notification.create
      data:
        title: "‚òï Caf√© en pr√©paration"
        message: "Caf√© lanc√© (switch.priscafe) | Satellite : `{{ satellite_id }}`"

SetHouseToSleep:
  action:
    - variables:
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    - service: automation.trigger
      target:
        entity_id: automation.mode_dodo_2
    - service: persistent_notification.create
      data:
        title: "üåô Mode Dodo"
        message: "Activation du dodo (automation.mode_dodo_2) | Satellite : `{{ satellite_id }}`"
