# ==========================================================
# LOGIQUE DES INTENTS - PHASE 2 (MODULAIRE)
# ==========================================================
# Ce fichier traite les ordres re√ßus apr√®s la reconnaissance vocale.
# Il utilise le contexte (quelle pi√®ce a parl√©) pour agir.
# ==========================================================

# ----------------------------------------------------------
# MODULE 1 : √âCLAIRAGE CONTEXTUEL
# ----------------------------------------------------------

TurnOnContextualLight:
  action:
    # 1. On r√©cup√®re la pi√®ce m√©moris√©e par le sensor de satellite
    - variables:
        piece: "{{ states('sensor.satellite_actif_memorise') | lower }}"
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    
    # 2. On allume la lumi√®re correspondante (Pattern: light.hue_<piece>)
    - service: light.turn_on
      target:
        entity_id: "light.hue_{{ piece }}"
    
    # 3. Notification HA pour confirmer que la d√©tection a fonctionn√©
    - service: persistent_notification.create
      data:
        title: "üí° Lumi√®re Allum√©e"
        message: "Pi√®ce : **{{ piece }}** | Satellite : `{{ satellite_id }}`"

TurnOffContextualLight:
  action:
    - variables:
        piece: "{{ states('sensor.satellite_actif_memorise') | lower }}"
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    
    - service: light.turn_off
      target:
        entity_id: "light.hue_{{ piece }}"
        
    - service: persistent_notification.create
      data:
        title: "üåë Lumi√®re √âteinte"
        message: "Pi√®ce : **{{ piece }}** | Satellite : `{{ satellite_id }}`"

# ----------------------------------------------------------
# MODULE 2 : VOLETS CONTEXTUELS
# ----------------------------------------------------------

TurnOnContextualCover:
  action:
    - variables:
        piece: "{{ states('sensor.satellite_actif_memorise') | lower }}"
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    
    # On ouvre le volet correspondant (Pattern: cover.vol<piece>)
    - service: cover.open_cover
      target:
        entity_id: "cover.vol{{ piece }}"
        
    - service: persistent_notification.create
      data:
        title: "ü™ü Volet Ouvert"
        message: "Pi√®ce : **{{ piece }}** | Satellite : `{{ satellite_id }}`"

TurnOffContextualCover:
  action:
    - variables:
        piece: "{{ states('sensor.satellite_actif_memorise') | lower }}"
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    
    # On ferme le volet correspondant
    - service: cover.close_cover
      target:
        entity_id: "cover.vol{{ piece }}"
        
    - service: persistent_notification.create
      data:
        title: "ü™ü Volet Ferm√©"
        message: "Pi√®ce : **{{ piece }}** | Satellite : `{{ satellite_id }}`"

# ----------------------------------------------------------
# MODULE 3 : RACCOURCIS (SHORTCUTS)
# ----------------------------------------------------------

StartCoffeeLoop:
  action:
    - variables:
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    
    # On active la prise de la machine √† caf√©
    - service: switch.turn_on
      target:
        entity_id: switch.priscafe
        
    - service: persistent_notification.create
      data:
        title: "‚òï Caf√© en pr√©paration"
        message: "Caf√© lanc√© (switch.priscafe) | Satellite : `{{ satellite_id }}`"

SetHouseToSleep:
  action:
    - variables:
        satellite_id: "{{ state_attr('sensor.satellite_actif_memorise', 'satellite_id') }}"
    
    # On d√©clenche une automatisation globale de mise en sommeil
    - service: automation.trigger
      target:
        entity_id: automation.mode_dodo_2
        
    - service: persistent_notification.create
      data:
        title: "üåô Mode Dodo"
        message: "Activation du dodo (automation.mode_dodo_2) | Satellite : `{{ satellite_id }}`"
