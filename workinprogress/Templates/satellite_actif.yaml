# ==========================================================
# SENSOR : DÉTECTION DU SATELLITE EN ÉCOUTE
# ==========================================================
# Ce sensor surveille l'état de tous les satellites et identifie
# celui qui est en train d'écouter (state = 'listening')
# ==========================================================

- sensor:
    - name: "Satellite Actif"
      unique_id: satellite_actif
      state: >
        {# Liste de tous vos satellites avec leur pièce associée #}
        {% set satellites = {
          'assist_satellite.esp_va_salon_satellite_assist': 'salon',
          'assist_satellite.esp_va_cuisine_satellite_assist': 'cuisine',
          'assist_satellite.respeaker_chambre_satellite_assist': 'chambre',
          'assist_satellite.atom_echo_sdb_satellite_assist': 'sdb'
        } %}
        
        {# Parcourir tous les satellites pour trouver celui qui écoute #}
        {% set ns = namespace(piece='inconnu') %}
        {% for satellite_id, piece in satellites.items() %}
          {% if is_state(satellite_id, 'listening') %}
            {% set ns.piece = piece %}
          {% endif %}
        {% endfor %}
        
        {{ ns.piece }}
      
      attributes:
        # Attribut : ID du satellite qui écoute
        satellite_id: >
          {% set satellites = {
            'assist_satellite.esp_va_salon_satellite_assist': 'salon',
            'assist_satellite.esp_va_cuisine_satellite_assist': 'cuisine',
            'assist_satellite.respeaker_chambre_satellite_assist': 'chambre',
            'assist_satellite.atom_echo_sdb_satellite_assist': 'sdb'
          } %}
          
          {% set ns = namespace(sat_id='aucun') %}
          {% for satellite_id, piece in satellites.items() %}
            {% if is_state(satellite_id, 'listening') %}
              {% set ns.sat_id = satellite_id %}
            {% endif %}
          {% endfor %}
          
          {{ ns.sat_id }}
        
        # Attribut : Enceinte Echo associée à la pièce
        echo: >
          {% set echo_map = {
            'salon': 'media_player.echo_studio_d',
            'cuisine': 'media_player.echo_show_cuisine',
            'chambre': 'media_player.echo_show_chambre',
            'sdb': 'media_player.echo_sdb'
          } %}
          
          {% set piece = states('sensor.satellite_actif') %}
          {{ echo_map.get(piece, 'media_player.echo_dot_gael') }}
